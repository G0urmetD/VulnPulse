#!/usr/bin/env python3
import requests
import os, sys

# url
CISA_URL = "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"
# agent http endpoint
AGENT_ENDPOINT = os.getenv("AGENT_ENDPOINT", "http://localhost:8088")

def fetch_and_post():
    try:
        r = requests.get(CISA_URL, timeout=30)
        r.raise_for_status()
        data = r.json()
        vulns = data.get("vulnerabilities", [])
    except Exception as e:
        print(f"Error loading CISA data: {e}", file=sys.stderr)
        return

    if not vulns:
        print("No vulnerabilities found.", file=sys.stderr)
        return

    try:
        resp = requests.post(
            AGENT_ENDPOINT,
            json=vulns,
            headers={"Content-Type": "application/json"},
            timeout=30
        )
        resp.raise_for_status()
        print(f"Successfully posted {len(vulns)} entries. Status: {resp.status_code}")
    except Exception as e:
        print(f"Error when posting to Elastic Agent: {e}", file=sys.stderr)

if __name__ == "__main__":
    fetch_and_post()
